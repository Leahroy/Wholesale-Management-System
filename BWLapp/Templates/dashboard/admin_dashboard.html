{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'BWLapp/css/admin_dashboard.css' %}">

    <style>
        .sidebar {
            transition: width 0.3s ease;
        }

        .sidebar.is-collapsed {
            width: 80px;
        }

        .sidebar.is-collapsed .welcome-text,
        .sidebar.is-collapsed .logo-section,
        .sidebar.is-collapsed .sidebar-text {
            display: none;
        }

        .sidebar.is-collapsed .sidebar-toggle {
            transform: rotate(180deg);
        }

        .main-content {
            transition: margin-left 0.3s ease;
        }

        .sidebar.is-collapsed + .main-content {
            margin-left: 80px;
        }
        
        .sidebar .sidebar-text {
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s ease, max-width 0.3s ease;
        }

        .sidebar.is-collapsed .sidebar-text {
            opacity: 0;
            max-width: 0;
        }
    </style>
</head>
<body class='flex flex-col min-h-screen'>
    <header class="main-header">
    <div class="logo-section mb-8">BMSapp</div>

    <div class="header-right-group">
            <div class="search-bar">
        <input type="text" placeholder="Search..." id="search-input" class="search-input">
        <div id="search-results" class="search-results-dropdown"></div>
    </div>
        <div class="flex items-center space-x-4">
            <div class="notification-container">
                <i class="fas fa-bell" id="notification-icon"></i>
                <span class="notification-count" id="notification-count">3</span>
                <div class="notification-dropdown" id="notification-dropdown">
                    <h4>Notifications</h4>
                    <ul id="notification-list">
                        {% for notification in notifications %}
                        <li>
                            <h4>{{ notification.message }}</h4>
                        </li>
                        {% empty %}<li>No new notifications.</li>{% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div id="profile-dropdown-container" class="profile-container cursor-pointer">
            <img src="{% if request.user.profile.profile_picture %}{{ request.user.profile.profile_picture.url }}{% else %}{% static 'images/profile.jpg' %}{% endif %}"
                    alt="Profile Picture" class="profile-image w-10 h-10 rounded-full object-cover">
            
            <div id="profile-dropdown-menu" class="profile-dropdown-menu">
                <a href="{% url 'profile' %}" class="dropdown-item"><i class="fas fa-user-cog"></i> View Profile</a>
                <a href="#" class="dropdown-item"><i class="fas fa-cog"></i> Settings</a>
                <a href="{% url 'logout' %}" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </div>
</header>

<div class="dashboard-container flex">
    
    <nav class="sidebar" id="sidebar">
        
        <div class="sidebar-header">
            <button id="sidebar-toggle" class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h2 class="welcome-text" id="welcome-message">Admin Dashboard</h2>
        </div>
        
        <ul>
            <li><a href="{% url 'admin_dashboard' %}"><i class="fas fa-home"></i><span class="sidebar-text">Dashboard</span></a></li>
            <li><a href="{% url 'employee-list' %}"><i class="fas fa-user-tie"></i><span class="sidebar-text">Employees</span></a></li>
            <li><a href="{% url 'customer-list' %}"><i class="fas fa-users"></i><span class="sidebar-text">Customers</span></a></li>
            <li><a href="{% url 'product-list' %}"><i class="fas fa-box-open"></i><span class="sidebar-text">Products</span></a></li>
            <li><a href="{% url 'stock-list' %}"><i class="fas fa-boxes"></i><span class="sidebar-text">Stocks</span></a></li>
            <li><a href="{% url 'order-list' %}"><i class="fas fa-receipt"></i><span class="sidebar-text">Orders</span></a></li>
            <li><a href="{% url 'payment-list' %}"><i class="fas fa-credit-card"></i><span class="sidebar-text">Transactions</span></a></li>
            <li class="active"><a href="{% url 'reports' %}"><i class="fas fa-chart-line"></i><span class="sidebar-text">Reports</span></a></li>
        </ul>
    </nav>

        <div class="main-content" id="main-content">
            <h1>Inventory Summary</h1>

            <div class="cards-container">
                <div class="card card-1">
                    <h3>Total Products</h3>
                    <p>{{ total_products|default:"0" }}</p>
                </div>
                <div class="card card-2">
                    <h3>Total Stock Quantity</h3>
                    <p>{{ total_stock_quantity|default:"0" }}</p>
                </div>
                <div class="card card-3">
                    <h3>Inventory Value</h3>
                    <p>K{{ total_inventory_value|floatformat:2|default:"0.00" }}</p>
                </div>

                <div class="card card-5">
                    <h3>Total Revenue</h3>
                    <p>K{{ total_revenue|floatformat:2|default:"0.00" }}</p>
                </div>

                                <div class="card card-4 alert-card">
                    <h3>Low Stock Alerts</h3>
                    <p>{{ low_stock_count|default:"0" }}</p>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h2>Monthly Sales</h2>
                    <canvas id="sales-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Product Categories</h2>
                    <canvas id="product-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Top 5 Best-Selling Products</h2>
                    <canvas id="top-products-chart"></canvas>
                </div>
            </div>
            <div class="critical-info-container">
                <section class="recent-activities">
                    <h2>Recent Activities</h2>
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Details</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in recent_activities %}
                            <tr>
                                <td>{{ activity.action }}</td>
                                <td>{{ activity.details }}</td>
                                <td>{{ activity.date }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3">No recent activity.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </section>
                
                <section class="low-stock-section">
                    <h2>Products Running Low on Stock</h2>
                    {% if low_stock_products %}
                    <div class="low-stock-grid">
                        {% for product in low_stock_products %}
                        <div class="low-stock-card">
                            <i class="fas fa-exclamation-triangle alert-icon"></i>
                            <div class="product-info">
                                <h3>{{ product.name }}</h3>
                                <p>Current Stock: <strong>{{ product.stock_quantity }}</strong></p>
                                <p>Threshold: <strong>{{ low_stock_threshold }}</strong></p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="no-low-stock-message">All products are well-stocked. üëç</p>
                    {% endif %}
                </section>
            </div>
        </div> 
    </div> 
        <footer class="dashboard-footer">
        <p>&copy; 2025 Bougainville Wholesale. All rights reserved.</p>
        <p>Developed by Leahroy Daing</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to the notification elements
        const notificationIcon = document.getElementById('notification-icon');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationCount = document.getElementById('notification-count');

        // Toggle the dropdown visibility when the bell icon is clicked
        notificationIcon.addEventListener('click', function(event) {
            notificationDropdown.classList.toggle('is-active');
            event.stopPropagation(); // Prevent the document click listener from firing immediately
        });

        // Hide the dropdown when clicking anywhere else on the page
        document.addEventListener('click', function(event) {
            if (!notificationDropdown.contains(event.target) && !notificationIcon.contains(event.target)) {
                notificationDropdown.classList.remove('is-active');
            }
        });

        // Update the notification count based on the number of list items
        function updateNotificationCount() {
            const count = notificationDropdown.querySelectorAll('li').length;
            notificationCount.textContent = count;
            notificationCount.style.display = count > 0 ? 'block' : 'none';
        }

        // Call the function on page load to set the initial count
        updateNotificationCount();

        // Profile dropdown functionality
        const profileDropdownContainer = document.getElementById('profile-dropdown-container');
        const profileDropdownMenu = document.getElementById('profile-dropdown-menu');

        profileDropdownContainer.addEventListener('click', () => {
            profileDropdownMenu.classList.toggle('is-active');
        });

        // Sidebar collapse/expand functionality
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('is-collapsed');
        });

        // =========================================================
        // START OF CORRECTED SEARCH SCRIPT
        // =========================================================
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        let searchTimeout;

        // Function to perform the search
        function performSearch(query) {
            if (query.length > 2) { // Only search after 2 or more characters
                fetch(`/search/?query=${query}`) // Use your defined search URL
                    .then(response => response.json())
                    .then(data => {
                        renderResults(data.results);
                    })
                    .catch(error => console.error('Error fetching search results:', error));
            } else {
                searchResults.innerHTML = '';
            }
        }

        // Listen for user input as they type
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value;
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300); // 300ms delay for live search
        });

        // Listen for the "Enter" key press to perform an immediate search
        searchInput.addEventListener('keydown', function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                clearTimeout(searchTimeout);
                const query = this.value;
                performSearch(query);
            }
        });

        function renderResults(results) {
            searchResults.innerHTML = ''; // Clear previous results
            if (results.length > 0) {
                const ul = document.createElement('ul');
                results.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${item.url}" class="search-result-item">
                                        <span class="search-result-label">${item.label}</span>
                                        <span class="search-result-type">${item.type}</span>
                                    </a>`;
                    ul.appendChild(li);
                });
                searchResults.appendChild(ul);
            } else {
                searchResults.innerHTML = '<div class="no-results">No results found.</div>';
            }
        }
        
        // =========================================================
        // END OF CORRECTED SEARCH SCRIPT
        // =========================================================
        
        // --- CHART DATA PARSING ---
        let salesLabels = [];
        let salesDataValues = [];
        let productLabels = [];
        let productDataValues = [];
        let topProductsLabels = [];
        let topProductsDataValues = []; // **NEW**

        try {
            salesLabels = JSON.parse('{{ sales_labels_json|safe }}');
        } catch (e) {
            console.error("Failed to parse sales labels JSON. Assuming empty array.", e);
        }

        try {
            salesDataValues = JSON.parse('{{ sales_data_json|safe }}');
        } catch (e) {
            console.error("Failed to parse sales data JSON. Assuming empty array.", e);
        }

        try {
            productLabels = JSON.parse('{{ product_labels_json|safe }}');
        } catch (e) {
            console.error("Failed to parse product labels JSON. Assuming empty array.", e);
        }

        try {
            productDataValues = JSON.parse('{{ product_data_json|safe }}');
        } catch (e) {
            console.error("Failed to parse product data JSON. Assuming empty array.", e);
        }
        
        // **NEW**: Parsing for Top Products
        try {
            topProductsLabels = JSON.parse('{{ top_products_labels_json|safe }}');
        } catch (e) {
            console.error("Failed to parse top products labels JSON. Assuming empty array.", e);
        }

        try {
            topProductsDataValues = JSON.parse('{{ top_products_data_json|safe }}');
        } catch (e) {
            console.error("Failed to parse top products data JSON. Assuming empty array.", e);
        }


        // --- CHART DATA DEFINITIONS ---

        const salesData = {
            labels: salesLabels,
            datasets: [{
                label: 'Sales (K)',
                data: salesDataValues,
                backgroundColor: 'rgba(85, 20, 180, 0.6)',
                borderColor: 'rgba(85, 20, 180, 1)',
                borderWidth: 1
            }]
        };

        const productData = {
            labels: productLabels,
            datasets: [{
                label: 'Product Categories',
                data: productDataValues,
                backgroundColor: [
                    '#6bb8ff',
                    '#38e1b9',
                    '#ff6b6b',
                    '#c0392b',
                    '#f1c40f'
                ],
                hoverOffset: 4
            }]
        };
        
        // **NEW**: Data for Top Products Chart
        const topProductsData = {
            labels: topProductsLabels,
            datasets: [{
                label: 'Total Revenue (K)',
                data: topProductsDataValues,
                backgroundColor: [
                    '#FF6384', // Red
                    '#36A2EB', // Blue
                    '#FFCE56', // Yellow
                    '#4BC0C0', // Teal
                    '#9966FF'  // Purple
                ],
                borderColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ],
                borderWidth: 1
            }]
        };


        // --- CHART CONFIGURATIONS ---

        const salesConfig = {
            type: 'bar',
            data: salesData,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        const productConfig = {
            type: 'pie',
            data: productData,
            options: {
                responsive: true,
            }
        };
        
        // **NEW**: Configuration for Top Products Chart
        const topProductsConfig = {
            type: 'bar', // Use 'bar' type with 'indexAxis: 'y'' for horizontal
            data: topProductsData,
            options: {
                indexAxis: 'y', // Makes it a horizontal bar chart
                responsive: true,
                scales: {
                    x: { // X-axis is now the value axis
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Revenue (K)'
                        }
                    }
                },
                legend: {
                    display: false
                }
            }
        };


        // --- CHART INSTANTIATION ---

        const salesChart = new Chart(
            document.getElementById('sales-chart'),
            salesConfig
        );

        const productChart = new Chart(
            document.getElementById('product-chart'),
            productConfig
        );
        
        // **NEW**: Instantiation for Top Products Chart
        const topProductsChart = new Chart(
            document.getElementById('top-products-chart'),
            topProductsConfig
        );
    });
</script>
</body>
</html>